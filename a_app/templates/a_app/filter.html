{% extends "base.html" %}
{% block title %}Collections{% endblock %}

{% block body %}
<div class="px-4 py-6 md:px-8 lg:px-16">

  <!-- Filter Section -->
  <form method="get" class="bg-white p-4 md:p-6  flex flex-col md:flex-row md:items-center md:justify-center md:gap-6">
    
    <!-- Filter By Category -->
    <div class="flex flex-col">
      <label for="filterBy" class="text-xs font-semibold text-gray-600 uppercase mb-1">Filter By</label>
      <select id="filterBy" name="filterBy" class="border border-gray-300 rounded-md px-3 w-64 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
        <option value="">All Categories</option>
        {% for category in categories %}
        {% with category.name|lower as cat_name %}
        <option value="{{ cat_name }}" {% if request.GET.filterBy == cat_name %}selected{% endif %}>{{ category.name }}</option>
        {% endwith %}
        {% endfor %}
      </select>
    </div>

    <!-- Sort By -->
    <div class="flex flex-col">
      <label for="sortBy" class="text-xs font-semibold text-gray-600 uppercase mb-1">Sort By</label>
      {% with request.GET.sortBy as sort_val %}
      <select id="sortBy" name="sortBy" class="border border-gray-300 rounded-md px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
        <option value="id" {% if sort_val == 'id' %}selected{% endif %}>ID</option>
        <option value="name" {% if sort_val == 'name' %}selected{% endif %}>Name</option>
        <option value="category" {% if sort_val == 'category' %}selected{% endif %}>Category</option>
        <option value="price-asc" {% if sort_val == 'price-asc' %}selected{% endif %}>Price Ascending</option>
        <option value="price-desc" {% if sort_val == 'price-desc' %}selected{% endif %}>Price Descending</option>
      </select>
      {% endwith %}
    </div>

    <!-- Apply Button -->
    <div class="flex items-end">
      <button type="submit" class="bg-green-500 text-white px-5 py-2 rounded-md text-sm font-semibold hover:bg-green-600 transition">Apply Filters</button>
    </div>

  </form>

  <!-- Results Info -->
  <div class="mt-4 text-gray-600 text-sm">Fetched {{ results_count }} items</div>

  <!-- Product Grid -->
  <div class="mt-6 grid gap-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
    {% for product in products %}
    <a href="{% url 'product' product.id %}" class="group relative bg-white border border-gray-200 rounded-lg overflow-hidden shadow hover:shadow-lg transition hover:-translate-y-1">
      
      <!-- Discount Badge -->
      {% if product.discount_price %}
      <span class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded">-{{ product.discount_percentage }}%</span>
      {% endif %}

      <!-- Wishlist Button -->
      <button onclick="toggleWishlist(this, {{ product.id }})"
        class="absolute top-2 right-2 w-10 h-10 rounded-full bg-white/90 flex items-center justify-center opacity-0 group-hover:opacity-100 transition hover:scale-110">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
      </button>

      <!-- Product Image -->
      <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-56 object-cover transition-transform duration-300 group-hover:scale-105">

      <!-- Product Info -->
      <div class="p-4">
        <div class="text-xs uppercase text-gray-500 mb-1">{{ product.category.name }}</div>
        <div class="text-lg font-semibold text-gray-800 mb-2">{{ product.name }}</div>
        <div class="flex items-center gap-2 mb-4">
          {% if product.discount_price %}
          <span class="line-through text-gray-400 text-sm">Rs.{{ product.price }}</span>
          <span class="text-black font-bold text-lg">Rs.{{ product.after_discount }}</span>
          {% else %}
          <span class="text-black font-bold text-lg">Rs.{{ product.price }}</span>
          {% endif %}
        </div>

        <!-- Add to Cart Button -->
        <button onclick="addToCart({{ product.id }}, event)" data-login-url="{% url 'login' %}" 
          class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-black text-white text-sm font-medium hover:bg-gray-800 transition">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l5.5 11" />
          </svg>
          Add to Cart
        </button>
      </div>

    </a>
    {% empty %}
    <p>No product matched your filter category</p>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <div class="mt-6 flex flex-wrap justify-center gap-2">
    {% if page_obj.has_previous %}
    <a href="?{% if request.GET.filterBy %}filterBy={{ request.GET.filterBy }}&{% endif %}{% if request.GET.sortBy %}sortBy={{ request.GET.sortBy }}&{% endif %}page={{ page_obj.previous_page_number }}" class="px-3 py-1 border rounded hover:bg-blue-500 hover:text-white transition">Previous</a>
    {% else %}
    <span class="px-3 py-1 border rounded text-gray-400">Previous</span>
    {% endif %}

    {% for num in paginator.page_range %}
      {% if num == page_obj.number %}
      <span class="px-3 py-1 border rounded bg-blue-500 text-white">{{ num }}</span>
      {% elif num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
      <a href="?{% if request.GET.filterBy %}filterBy={{ request.GET.filterBy }}&{% endif %}{% if request.GET.sortBy %}sortBy={{ request.GET.sortBy }}&{% endif %}page={{ num }}" class="px-3 py-1 border rounded hover:bg-blue-500 hover:text-white transition">{{ num }}</a>
      {% elif num == 1 or num == paginator.num_pages %}
      <a href="?{% if request.GET.filterBy %}filterBy={{ request.GET.filterBy }}&{% endif %}{% if request.GET.sortBy %}sortBy={{ request.GET.sortBy }}&{% endif %}page={{ num }}" class="px-3 py-1 border rounded hover:bg-blue-500 hover:text-white transition">{{ num }}</a>
      {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
      <span class="px-3 py-1">...</span>
      {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <a href="?{% if request.GET.filterBy %}filterBy={{ request.GET.filterBy }}&{% endif %}{% if request.GET.sortBy %}sortBy={{ request.GET.sortBy }}&{% endif %}page={{ page_obj.next_page_number }}" class="px-3 py-1 border rounded hover:bg-blue-500 hover:text-white transition">Next</a>
    {% else %}
    <span class="px-3 py-1 border rounded text-gray-400">Next</span>
    {% endif %}
  </div>

</div>
{% endblock %}
